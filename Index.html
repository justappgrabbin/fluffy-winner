<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ðŸŒ€ Sovereign AI | Causal OS</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root { --mind: #00d9ff; --heart: #ff1744; --body: #76ff03; --void: #0a0a0f; }
        body { margin: 0; background: var(--void); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #graph-layer { flex-grow: 1; position: relative; background: radial-gradient(circle, #15151c, #0a0a0f); border-bottom: 1px solid var(--mind); }
        #ai-supervisor { height: 55%; background: rgba(10, 10, 15, 0.98); padding: 15px; overflow-y: auto; z-index: 100; }
        
        textarea, input, button { width: 100%; background: #1a1a26; border: 1px solid var(--mind); color: #fff; padding: 12px; margin: 5px 0; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        button { background: var(--mind); color: #000; font-weight: bold; cursor: pointer; }
        .status-bar { font-size: 10px; color: var(--mind); display: flex; justify-content: space-between; margin-bottom: 8px; }
        .node { stroke: #fff; stroke-width: 1.5px; }
        .link { stroke: #999; stroke-opacity: 0.3; }
        .spark { stroke: var(--heart); stroke-width: 3px; stroke-dasharray: 4; animation: pulse 1s linear infinite; }
        @keyframes pulse { to { stroke-dashoffset: -8; } }
    </style>
</head>
<body>

    <div id="graph-layer"><svg id="graphSvg" style="width:100%; height:100%;"></svg></div>

    <div id="ai-supervisor">
        <div class="status-bar">
            <span>PYTHON: <b id="py-status">BOOTING...</b></span>
            <span>LLAMA-WASM: <b id="ai-status">LOADING...</b></span>
        </div>
        
        <textarea id="soc-stream" rows="2" placeholder="Stream: 'User Agency needs Causal Coherence'"></textarea>
        <button id="forge-btn" onclick="processAndForge()">FORGE WITH AI SUPERVISION</button>

        <div style="display:flex; gap:8px;">
            <input type="number" id="dna-gate" placeholder="Gate (1-64)">
            <button style="width:40%" onclick="mapDNA()">MAP DNA</button>
        </div>
        
        <div id="llama-terminal" style="font-size:12px; margin-top:12px; color:var(--body); border-left: 2px solid var(--heart); padding-left: 10px; min-height: 50px;">
            Awaiting Sovereign Instruction...
        </div>
    </div>

    <script type="module">
        import { LlamaModel } from "./llama-wasm.js";

        // --- 1. AI & PYTHON INITIALIZATION ---
        let pyodide;
        let model;

        async function initEngines() {
            // Init Python via Pyodide
            pyodide = await loadPyodide();
            document.getElementById('py-status').innerText = "STABLE";
            
            // Init Llama WASM
            try {
                model = await LlamaModel.load("tinyllama-q4.gguf");
                document.getElementById('ai-status').innerText = "ONLINE";
            } catch (e) {
                document.getElementById('ai-status').innerText = "WASM ERROR";
                console.error(e);
            }
        }

        // Make functions globally accessible for UI buttons
        window.processAndForge = async function() {
            const stream = document.getElementById('soc-stream').value;
            const terminal = document.getElementById('llama-terminal');
            terminal.innerText = "AI Auditing Causal Flow...";
            
            // 1. Generate AI Insight using the WASM model
            const aiResponse = await model.generate(`Task: Causal Architect. Input: "${stream}". Action: Audit for 8-layer coherence and suggest the missing link.`);
            terminal.innerText = aiResponse;

            // 2. Simple Causal Link Forging
            const parts = stream.toLowerCase().split(" needs ");
            if (parts.length === 2) {
                injectLink(parts[1].trim(), parts[0].trim());
            }
        };

        window.mapDNA = function() {
            const gate = document.getElementById('dna-gate').value;
            injectNode("Gate_" + gate, 3, gate);
        };

        window.onload = initEngines;

        // --- 2. GRAPH LOGIC (D3.js) ---
        let nodes = [{ id: "Physics", layer: 0 }, { id: "Agency", layer: 4 }];
        let links = [];
        const svg = d3.select("#graphSvg");
        let sim = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(70))
            .force("charge", d3.forceManyBody().strength(-150))
            .force("center", d3.forceCenter(window.innerWidth / 2, window.innerHeight * 0.2));

        function renderGraph() {
            svg.selectAll("*").remove();
            const l = svg.append("g").selectAll("line").data(links).enter().append("line").attr("class", "link");
            const n = svg.append("g").selectAll("circle").data(nodes).enter().append("circle")
                .attr("r", 12).attr("fill", d => d3.interpolateTurbo(d.layer / 7))
                .call(d3.drag().on("start", dragStart).on("drag", dragging).on("end", dragEnd));
            
            sim.nodes(nodes); sim.force("link").links(links); sim.alpha(1).restart();
            sim.on("tick", () => {
                l.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                n.attr("cx", d => d.x).attr("cy", d => d.y);
            });
        }

        function injectNode(id, layer, gate = null) {
            if (!nodes.find(n => n.id === id)) {
                nodes.push({ id, layer, gate });
                renderGraph();
            }
        }

        function injectLink(source, target) {
            injectNode(source, 2); injectNode(target, 5);
            links.push({ source, target });
            renderGraph();
        }

        function dragStart(e, d) { if (!e.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
        function dragging(e, d) { d.fx = e.x; d.fy = e.y; }
        function dragEnd(e, d) { if (!e.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }

        renderGraph();
    </script>
</body>
</html>
